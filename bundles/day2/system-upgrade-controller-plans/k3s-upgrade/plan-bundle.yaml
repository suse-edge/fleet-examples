kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: k3s-upgrade
  namespace: fleet-default
spec:
  resources:
  - content: |
      # control-plane upgrade plan
      apiVersion: upgrade.cattle.io/v1
      kind: Plan
      metadata:
        name: k3s-plan-control-plane
        namespace: cattle-system
        labels:
          k3s-upgrade: control-plane
      spec:
        concurrency: 1
        nodeSelector:
          matchExpressions:
            # will trigger upgrade for any node containing the 'node-role.kubernetes.io/control-plane' label
            - {key: node-role.kubernetes.io/control-plane, operator: In, values: ["true"]}
        tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Equal"
          value: "true"
          effect: "NoExecute"
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Equal"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/etcd"
          operator: "Equal"
          effect: "NoExecute"
        serviceAccountName: system-upgrade-controller
        cordon: true
        upgrade:
          image: rancher/k3s-upgrade
        version: v1.28.8+k3s1
      ---
      # worker upgrade plan
      apiVersion: upgrade.cattle.io/v1
      kind: Plan
      metadata:
        name: k3s-plan-agent
        namespace: cattle-system
        labels:
          k3s-upgrade: agent
      spec:
        concurrency: 2 
        nodeSelector:
          matchExpressions:
            # will trigger upgrade for any node that does not contain the 'node-role.kubernetes.io/control-plane' label
            - {key: node-role.kubernetes.io/control-plane, operator: NotIn, values: ["true"]}
        serviceAccountName: system-upgrade-controller
        prepare:
          image: rancher/k3s-upgrade
          args:
          - prepare
          - k3s-plan-control-plane
        drain:
          force: true
          skipWaitForDeleteTimeout: 60
        upgrade:
          image: rancher/k3s-upgrade
        version: v1.28.8+k3s1
    name: k3s-upgrade-bundle.yaml
  targets:
  # Match nothing, user needs to specify targets
  - clusterSelector: null
